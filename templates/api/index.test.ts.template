import { describe, it, expect } from 'vitest';
import app from './index';

describe('API Endpoints', () => {
  describe('GET /api/echo', () => {
    it('should return hello world', async () => {
      const req = new Request('http://localhost/api/echo');
      const res = await app.fetch(req, { D1: {} as any, KV: {} as any });
      expect(res.status).toBe(200);

      const data = await res.json();
      expect(data).toEqual({ hello: 'world' });
    });
  });

  describe('POST /api/echo', () => {
    it('should echo back the message', async () => {
      const req = new Request('http://localhost/api/echo', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: 'test message' }),
      });

      const res = await app.fetch(req, { D1: {} as any, KV: {} as any });
      expect(res.status).toBe(200);

      const data = await res.json();
      expect(data).toEqual({
        echo: {
          message: 'test message',
        },
      });
    });

    it('should handle empty message', async () => {
      const req = new Request('http://localhost/api/echo', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: '' }),
      });

      const res = await app.fetch(req, { D1: {} as any, KV: {} as any });
      // The endpoint should validate and return an error for empty messages
      expect(res.status).toBe(400);
    });
  });
});
