import { test, expect } from '@playwright/test';

test.describe('API Echo Endpoints', () => {
  test('should load the home page', async ({ page }) => {
    await page.goto('/');

    // Check that the page title is correct
    await expect(page).toHaveTitle('{{PROJECT_NAME}}');

    // Check that the main heading is visible
    await expect(page.locator('h1')).toContainText('{{PROJECT_NAME}}');
  });

  test('should test GET /api/echo endpoint', async ({ page }) => {
    await page.goto('/');

    // Wait for hydration - button becomes enabled
    const getButton = page.locator('button', { hasText: 'Send GET Request' });
    await expect(getButton).toBeEnabled();

    // Click the "Send GET Request" button
    await getButton.click();

    // Wait for the response card to appear
    await expect(page.locator('text=Response')).toBeVisible({ timeout: 5000 });

    // Check that the response contains the expected data
    const responseText = await page.locator('pre code').textContent();
    expect(responseText).toContain('"hello": "world"');
  });

  test('should test POST /api/echo endpoint', async ({ page }) => {
    await page.goto('/');

    const testMessage = 'Hello from E2E test!';

    // Wait for hydration - input becomes enabled
    const input = page.locator('input#message');
    await expect(input).toBeEnabled();

    // Find the input field and enter a message
    await input.fill(testMessage);

    // Wait for button to be enabled and click
    const postButton = page.locator('button', { hasText: 'Send POST Request' });
    await expect(postButton).toBeEnabled();
    await postButton.click();

    // Wait for the response card to appear
    await expect(page.locator('text=Response')).toBeVisible({ timeout: 5000 });

    // Check that the response contains the echoed message
    const responseText = await page.locator('pre code').textContent();
    expect(responseText).toContain('"echo"');
    expect(responseText).toContain(testMessage);
  });

  test('should show error for empty POST message', async ({ page }) => {
    await page.goto('/');

    // Wait for hydration
    const postButton = page.locator('button', { hasText: 'Send POST Request' });
    await expect(postButton).toBeEnabled();

    // Don't fill in the input, just click the button
    await postButton.click();

    // Should show an error message
    await expect(page.locator('text=Error')).toBeVisible({ timeout: 2000 });
  });

  test('should display tech stack information', async ({ page }) => {
    await page.goto('/');

    // Check that tech stack section exists
    const techStack = page.getByText('Tech Stack', { exact: true });
    await expect(techStack).toBeVisible();

    // Check frontend technologies
    await expect(page.getByText('SvelteKit')).toBeVisible();
    await expect(page.getByText('TailwindCSS')).toBeVisible();
    await expect(page.getByText('Shadcn-svelte')).toBeVisible();

    // Check backend technologies
    await expect(page.getByText('@hono/zod-openapi')).toBeVisible();
    await expect(page.getByText('Cloudflare Workers')).toBeVisible();
  });
});
